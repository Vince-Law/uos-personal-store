version: '3.8'
services:
  app_proxy:
    environment:
      APP_HOST: wild-gablota-recipe-notebook_app_1
      APP_PORT: 3000
      PROXY_AUTH_ADD: 'false'
    dns:
      - 1.1.1.1
      - 8.8.8.8
    container_name: wild-gablota-recipe-notebook_app_proxy_1

  postgres:
    image: >-
      postgres:16-alpine@sha256:d898b0b78a2627cb4ee63464a14efc9d296884f1b28c841b0ab7d7c42f1fffdf
    restart: on-failure
    stop_grace_period: 1m
    environment:
      POSTGRES_USER: recipe_user
      POSTGRES_PASSWORD: ${APP_SEED}
      POSTGRES_DB: recipe_notebook
      POSTGRES_INITDB_ARGS: '-E UTF8 --locale=C'
    dns:
      - 1.1.1.1
      - 8.8.8.8
    volumes:
      - ${APP_DATA_DIR}/data/postgres:/var/lib/postgresql/data
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U recipe_user -d recipe_notebook
      interval: 10s
      timeout: 5s
      retries: 5
    container_name: wild-gablota-recipe-notebook_postgres_1

  app:
    image: maksimab/recipe_notebook:1.6.1
    restart: on-failure
    stop_grace_period: 1m
    init: true
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: >-
        postgresql://recipe_user:${APP_SEED}@wild-gablota-recipe-notebook_postgres_1:5432/recipe_notebook
      JWT_SECRET: ${APP_SEED}
      GEMINI_API_KEY: ""
    dns:
      - 1.1.1.1
      - 8.8.8.8
    volumes:
      - ${APP_DATA_DIR}/data/uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - wget
        - '--no-verbose'
        - '--tries=1'
        - '--spider'
        - 'http://localhost:3000/api/health'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    container_name: wild-gablota-recipe-notebook_app_1
